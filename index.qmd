---
title: "Geocomputation with R's guide <br>to reproducible <br>spatial data analysis"
author: "Jakub Nowosad, https://jakubnowosad.com/"
institute: "OpenGeoHub Summer School 2022"
date: "2022-08-30"
date-format: iso
format:
  n3-revealjs:
    echo: true
    highlight-style: github
    slide-number: c/t
    width: 1600
    height: 900
    footer: "[jakubnowosad.com/ogh2022](https://jakubnowosad.com/ogh2022/)"
    transition: none
---

# Chapter 1: Geocomputation

<!-- 1.5h + 1.5h -->
<!-- 100 slides top! -->

---

<!-- openshaw -->
<!-- currently an obvious thing -->
<!-- what it involves -->
<!-- connection between different fields -->

::: {.r-fit-text}
(geo)spati|graphic)\*(al)\*

( )\*(stuff|data|comput|inform)\*(ing|ation)\*

(science|systems|theory|analysis)\*
:::


Based on the David O’Sullivan's talk title at the Geocomputation 2019 conference

---

::: {.r-fit-text}
(**geo**)spati|graphic)\*(al)\*

( )\*(stuff|data|**comput**|inform)\*(ing|**ation**)\*

(science|systems|theory|analysis)\*
:::

Based on the David O’Sullivan's talk title at the Geocomputation 2019 conference


---

```{r gdsl, echo=FALSE, message=FALSE}
d = readr::read_csv("data/gis-vs-gds-table.csv")
knitr::kable(x = d, 
             caption = paste("Differences in emphasis between software", 
                             "packages (Graphical User Interface (GUI) of", 
                             "Geographic Information Systems (GIS) and R)."),
             caption.short = "Differences between GUI and CLI",
             booktabs = TRUE)
```

<!-- This book is motivated by the importance of reproducibility\index{reproducibility} for scientific research (see the note below). -->
<!-- It aims to make reproducible geographic data analysis\index{geographic data analysis} workflows more accessible, and demonstrate the power of open geospatial software available from the command-line. -->

# GIS Applications

:::: {.columns}

::: {.column width="50%"}
```{r, echo=FALSE, warning=FALSE, fig.height=7}
# install.packages("wordcloud")
library(wordcloud)
w = c("Ecology", "Earth-Observation", "Economics", "Demography",
  "Politics", "Journalism", "History", "Archeology", "Transport", 
  "Climatology", "Meteorology")
w2 = c("Geomorphometry", "Astronomy", "Architecture", "Hydrology",
       "Insurance", "Urban-Planning", "Mining", "Marine-Studies",
       "Soil-Science", "Sport", "Telecomunication", "Tourism")
wordcloud(c(w), rot.per = 0.2)
```
:::

:::  {.column width="40%"}
```{r}
#| echo = FALSE,
#| fig.height=7
wordcloud(c(w2), rot.per = 0.2)
```
:::

::::

## Data models

<!-- Traditionally, spatial data is described by two basic data models: vector data model aimed at representing the world using points, lines, and polygons, and raster data model focused on representing surfaces -->

---

![Source: https://r-tmap.github.io/](figs/vector-data-model-1.png)

---

![Source: https://r-tmap.github.io/](figs/raster-intro-1.png)

---

![Source: https://r-tmap.github.io/](figs/vector-data-cubes-1.png){.r-stretch}
![Source: https://r-tmap.github.io/](figs/raster-data-cubes-1.png){.r-stretch}

---

![Source: https://github.com/Jean-Romain/lidR](figs/point-cloud-rotating.gif)

## Coordinate reference systems

## Data sources

<!-- Źródła danych, pliki, servery, stac, gee, closed and open,  -->
<!-- zarr, cog, parquet, geoarrow -->
<!-- https://t.co/ra3O5HiwjR -->

## Data processing

## Basic vector operations

- Simplification
- Intersect
- Additional topological relations
- Spatial joins
- Centroids
- Buffers

## Map algebra

Used for a various task related to spatial raster data.

It can be divided into four groups:

1. **Local** - per-cell operations
2. **Focal (neighborhood operations)** - most often the output cell value is the result of a 3 x 3 input cell block
3. **Zonal operations** - to summarize raster values for some zones (usually irregular areas)
4. **Global** - to summarize raster values for one or several rasters

## Raster-vector interactions

1. Raster cropping and masking
2. Raster extraction - by points, lines, and polygons
3. Rasterization - points, lines, polygons to rasters
4. Vectorization - rasters to polygons or contours

<!-- reprojections? -->

## Spatial data analysis

```{dot}
#| echo = FALSE
digraph G {
     layout=circo
     rankdir=LR
     
     node [shape=circle];
     cir1 [label="Spatial analysis"];
     
     node [shape=rectangle];
     rec1 [label="Spatial autocorrelation"];
     rec2 [label="Spatial interpolation"];
     rec3 [label="Spatial interaction"];
     rec4 [label="Simulation and modeling"];
     rec5 [label="Density mapping"];
     
     rec1 -> cir1;
     rec2 -> cir1;
     rec3 -> cir1;
     rec4 -> cir1;
     rec5 -> cir1;
     }
```

*(incomplete list)*

## Spatial data analysis


```{dot d2}
#| echo = FALSE
digraph G2 {
   layout=circo
   rankdir=LR
   
   node [shape = circle];
   cir1 [label = "Spatial analysis"];
   
   node [shape = rectangle];
   rec1 [label = "Spatial modeling"];
   rec2 [label = "Point pattern analysis"];
   rec3 [label = "Network analysis"];
   rec4 [label = "Surface analysis"];
   rec5 [label = "Grid analysis"];
   rec6 [label = "Single-layer operations"];
   rec7 [label = "Multi-layer operations"];
   
   rec1 -> cir1;
   rec2 -> cir1;
   rec3 -> cir1;
   rec4 -> cir1;
   rec5 -> cir1;
   rec6 -> cir1;
   rec7 -> cir1;
   }
```
*(incomplete list)*

## Geocomputational methods

- Exploratory data analysis (EDA)
- Data processing (e.g., adding new variables)
- Data transformation (e.g., changing CRS, reducing size via simplification/aggregation)
- Data visualization
- Web application development
- Software development (e.g., to share new methods)

## Spatial vizualizations

# Chapter 2: Geocomputation with R

## Ecosystems

<!-- more than one way to solve a problem -->

---

- [{sf}](https://github.com/r-spatial/sf),
[{sp}](https://github.com/edzer/sp),
[{terra}](https://github.com/rspatial/terra),
[{raster}](https://github.com/rspatial/raster), [{stars}](https://github.com/r-spatial/stars) - spatial classes
- [{dplyr}](https://github.com/tidyverse/dplyr), [{rmapshaper}](https://github.com/ateucher/rmapshaper) - processing of attribute tables/geometries 
- [{rnaturalearth}](https://github.com/ropensci/rnaturalearth), [{osmdata}](https://github.com/ropensci/osmdata) - spatial data download
- [{rgrass}](https://github.com/rsbivand/rgrass), [{qgisprocess}](https://github.com/paleolimbot/qgisprocess), [{link2GI}](https://github.com/r-spatial/link2GI) - connecting with GIS software
- [{gstat}](https://github.com/r-spatial/gstat), [{mlr3}](https://github.com/mlr-org/mlr3), [{CAST}](https://github.com/HannaMeyer/CAST) - spatial data modeling
- [{rasterVis}](https://github.com/oscarperpinan/rastervis), [{tmap}](https://github.com/mtennekes/tmap), [{ggplot2}](https://github.com/tidyverse/ggplot2) - static visualizations
- [{leaflet}](https://github.com/rstudio/leaflet), [{mapview}](https://github.com/r-spatial/mapview), [{mapdeck}](https://github.com/SymbolixAU/mapdeck) - interactive visualizations
- [{spatstat}](http://spatstat.org/), [{spdep}](https://github.com/r-spatial/spdep), [{spatialreg}](https://github.com/r-spatial/spatialreg), [{dismo}](https://github.com/rspatial/dismo), [{landscapemetrics}](https://github.com/r-spatialecology/landscapemetrics), [{RStoolbox}](http://bleutner.github.io/RStoolbox/rstbx-docu/RStoolbox.html), [{rayshader}](https://github.com/tylermorganwall/rayshader), [{gdalcubes}](https://github.com/appelmar/gdalcubes_R), [{sfnetworks}](https://github.com/luukvdmeer/sfnetworks) - different types of spatial data analysis
- many more...

Visit https://cran.r-project.org/view=Spatial to get an overview of different spatial tasks that can be solved using R.

---

![Source: https://geocompr.robinlovelace.net](https://geocompr.robinlovelace.net/figures/01-cranlogs.png)

---

```{r}
library(spData)
library(sf)
world
```

---

```{r}
plot(world)
```

---

![Source: https://www.r-spatial.org/r/2020/03/17/wkt.html](https://keen-swartz-3146c4.netlify.com/images/sf_deps.png)

<!-- + mention bridges -->

---

![](figs/terra-libs.png)

---

```{r}
library(terra)
srtm = rast(system.file("raster/srtm.tif", package = "spDataLarge"))
srtm
```

---

```{r}
plot(srtm)
```

---


- [rspatial](https://www.rspatial.org/) vs [r-spatial](https://www.r-spatial.org/)
- Old vs New
- [Legacy](https://geocompr.robinlovelace.net/intro.html#the-history-of-r-spatial)
- Other R ecosystems


---

![{stars} - https://r-spatial.github.io/stars/](figs/cube2.png)


---

![{s2} - https://r-spatial.github.io/s2/](figs/s2.png)

<!-- also geoarrow -->

---

![{lidR} - https://github.com/r-lidar/lidR](figs/lidr.png)

---

![{sfnetwork} - https://luukvdmeer.github.io/sfnetworks](figs/sfnetwork.png)

---

![{spatstat} - https://spatstat.org/](figs/spatstat.png)

<!-- ecosystem of packages on its own! -->

---

![hypertidy-verse - https://github.com/hypertidy](figs/hypertidy.png)


---

![](figs/supercells.png)

---

<!-- Spiderweb of interconnection -->
<!-- small -->

---

<!-- Spiderweb of interconnection -->
<!-- large -->

---

```{r}
#| echo: false
#| fig-width: 12
#| fig-height: 7
library(miniCRAN)
dg = makeDepGraph("supercells", enhances = TRUE)
set.seed(1)
plot(dg, legendPosition = c(-1, -1), vertex.size = 10, cex = 0.7)
```

<!-- tmap? -->

<!-- My supercells example? -->
<!-- conversions -->

---
## Exercises

<!-- exercises -->
<!-- two or three levels of difficulty -->
<!-- Exercise: includes downloading files online, some function that is new,  -->

# Chapter 3: Reproducible analysis

<!-- ladder -->
<!-- over space and time -->

# Chapter 4: Reproducible geocomputation

<!-- https://kbroman.org/knitr_knutshell/pages/reproducible.html -->

<!-- R (code) -->
<!-- renv -->
<!-- github actions -->
<!-- quarto -->
<!-- docker -->
<!-- targets -->
<!-- r packages -->

<!-- Each tool plus (real life) example -->

<!-- Gify? -->

<!-- Potential issues (e.g. terra pointers, software versions, both external and R, differences between operating systems, large data, computionlay demanding operations) -->

<!-- Counterexercise: give a code that worked in the past -- fix it! -->

<!-- exercise: -->
<!-- make the code reproducible -->

# The end

https://jakubnowosad.com/ogh2022/